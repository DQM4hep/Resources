%%%%%%%%%%%%%%%%%%%%%%% file template.tex %%%%%%%%%%%%%%%%%%%%%%%%%
%
% This is a template file for Web of Conferences Journal
%
% Copy it to a new file with a new name and use it as the basis
% for your article
%
%%%%%%%%%%%%%%%%%%%%%%%%%% EDP Science %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%\documentclass[option]{webofc}
%%% "twocolumn" for typesetting an article in two columns format (default one column)
%
\documentclass{webofc}
\usepackage[varg]{txfonts}   % Web of Conferences font
\usepackage{listings}
\usepackage{xcolor}

\lstset { %
    belowcaptionskip=1\baselineskip,
    breaklines=true,
    % frame=L,
    xleftmargin=\parindent,
    language=C++,
    showstringspaces=false,
    basicstyle=\footnotesize\ttfamily,
    keywordstyle=\bfseries\color{green!40!black},
    commentstyle=\itshape\color{purple!40!black},
    identifierstyle=\color{blue},
    stringstyle=\color{orange},
    numbers=left
    % language=C++,
    % basicstyle=\ttfamily,
    % keywordstyle=\color{red}\ttfamily,
    % stringstyle=\color{gray}\ttfamily,
    % commentstyle=\color{blue}\ttfamily,
    % morecomment=[l][\color{magenta}]{\#}
    % backgroundcolor=\color{black!5}, % set backgroundcolor
    % basicstyle=\footnotesize,% basic font setting
    % numbers=left
}

%
% Put here some packages required or/and some personnal commands
%
%
\begin{document}
%
\title{DQM4hep}
%
% subtitle is optionnal
%
\subtitle{A generic data quality monitoring framework for HEP}

\author{
\firstname{R\'emi} \lastname{Ete}\inst{1}\fnsep\thanks{\email{remi.ete@desy.de}}
\and
\firstname{Antoine} \lastname{Pingault}\inst{2}\fnsep\thanks{\email{antoine.pingault@ugent.be}}
}

\institute{
DESY, Notkestra\ss e 85, 22607 Hamburg, Germany
\and
Ghent University, Department of Physics and Astronomy Proeftuinstraat 86, B-9000 Gent, Belgium
}

\abstract{%
Data quality monitoring is the first step to the certification of the recorded data for offline physics analysis.
Dedicated monitoring framework have been developed by many experiments in the past and usually rely on the event data
model (EDM) of the experiment, leading to a strong dependency on the data format and storage. We present here a generic
data quality monitoring system, DQM4HEP, that has been developed without any assumption on the EDM. This increases the
code maintenance, the portability across different experiments and re-usability for future experiments.
We present the framework architecture and the various tools provided by the software package as well as various
performances such as memory usage, stability and network bandwidth. We give an overview of the different experiments
using DQM4HEP and the foreseen integration in future other experiments. We finally present the ongoing and future
software development for DQM4HEP and long term prospects.
}
%
\maketitle
%
\section{Introduction}
\label{sec:intro}

Online monitoring systems are crucial while taking experimental data. 
The main tasks of these systems are to provide a quick overview of the detector and sub-detector status, and to evaluate the quality of these data. 
More technically, the online framwork should provide the following ingredients:

\begin{itemize}
  \item a DAQ link to access the detector data and the run control status,
  \item a dedicated online analysis framework,
  \item a visualization system to show the resulting analysis products.
\end{itemize}

Such systems are generally (but not always) decoupled from the data quality monitoring done offline on recorded data or simulated data.
Often, the architecture of these software relies on the event data model (EDM) of the underlying experiment and 
can be seen as a limitation, as the software becomes non-reusable by other experiments.

In this paper, we present a new generic framework for online and offline monitoring called DQM4hep. 
After introducing the framework architecture and specifications, the different components of DQM4hep are described. 
The software still being in development, we conclude with a few perspective and incoming features.

\section{The DQM4hep framework}
\label{sec:framework}

\subsection{Software architecture and specifications}
\label{subsec:arch}

The DQM4hep framework is built on top of the so-called plugin system component. 
A plugin is a C++ class encapsulating a user class that is compiled in a shared library and loaded at runtime by the plugin system. 
The plugin is used as a factory to create instances of the user class on demand.
Such a system allows for building a framework with which the behavior of the key components can be changed at runtime. 

In order to have a really generic monitoring system, the software should not depend on any EDM or data format. 
This allows to have a higly-reusable software for different experiments. 
By construction, in DQM4hep, the data type is user defined and wrapped in a higher level structure (\texttt{dqm4hep::Event}). 
As the data has to be transported over network, the data streaming, as well as file reading and writing facility, have to be user-defined.
The user-streaming interface can be encapsulated in a plugin that the framework can use in online application to serialize (de-serialize) 
data before sending (after receiving) to (from) an endpoint.

An important requirement for the online component of the monitoring system is to be distributed. 
A typical user analysis handles hundred or many hundreds of histograms that are filled whenever data are received from the DAQ system. 
The analysis program in this case is particularly \textit{greedy} in terms of memory. 
Analysing data in a single process is thus very limited and must be distributed over different process or computers depending on 
the available resources on each machine. This also increase the speedup of analysis as the resources are shared and allows for 
more data to be processed in the same amount of time. The online analysis application has to be carefully designed in terms of 
memory management as it may run for many hours and must stay stable.

To receive data from the DAQ system, data must be forwared to the monitoring system for analysis.
The mechanism may be of many forms: shared-memory (if running on same computers), network (TCP/IP), database, etc...
An important requirement of a DQM system is to avoid slowing the acquisition or either crash the acquisition process.
%do not impact on the performance of the data acquisition itself to perform a 
%monitoring task. By performance here we mean slowing down the acquisition or either crash the acquisition process.

\subsection{The core components}
\label{subsec:core}

\paragraph{The plugin system}

As stated before, DQM4hep is built on top a plugin system. 
The \texttt{dqm4hep::PluginManager} class is a singleton class holding all plugins within an application. 
The plugins are loaded by opening shared libraries using the \texttt{::dlopen()} function at startup. 
A user class object can be created on the heap by querying a specific plugin (by name) to the \texttt{dqm4hep::PluginManager} and 
by calling \texttt{dqm4hep::Plugin::create()}.

\paragraph{The event data model}

The core component of DQM4hep defines a high level class \texttt{Event} to handle a user-defined event class.
This handler is particularly useful because it allows to transport the user-defined event through an application
workflow without making any assumption on the underlying implementation:

\begin{lstlisting}
// a user defined function
dqm4hep::EventPtr createEvent() {
  // a DQM4hep event ...
  dqm4hep::EventPtr event = dqm4hep::Event::create<MyEvent>();
  // ... wrapping a user-defined structure
  MyEvent *myevt = event->get<MyEvent>();
  myevt->setTimeStamp(time(0));
  myevt->setData({0.5, 856., 485.});
  return event;
}
\end{lstlisting}

\paragraph{Event streaming}

To send or receive events from the network, events have to be converted from or to a format that the transport system can handle (e.g binary). 
As the event is user-defined, the event streaming also has to be user-defined. 
The framework defines a base class \texttt{dqm4hep::EventStreamerPlugin} to stream in and out event that users have to implement:

\begin{lstlisting}
class EventStreamerPlugin {
public:
  // creates user-defined event
  virtual EventPtr createEvent() const = 0;
  // write event to TBuffer object
  virtual StatusCode write(EventPtr event, TBuffer &buffer) = 0;
  // read event from TBuffer object
  virtual StatusCode read(EventPtr event, TBuffer &buffer) = 0;
};
\end{lstlisting}

The user implementation can be declared as a plugin and loaded at runtime by the \texttt{dqm4hep::PluginManager}. 
The combinaison of \texttt{dqm4hep::PluginManager}, \texttt{dqm4hep::Event} and \texttt{dqm4hep::EventStreamerPlugin} gives the 
fully required flexibility for such a framework. 

\paragraph{Monitor elements}

The concept of \textit{monitor element} is central in data quality monitoring software.
A monitor element encasulate a summary of the data being monitored by the framework.
The most commonly used monitor element kind in HEP is histogram, but can also be a scalar value, 
time stamped graph (slow control), 2D histograms (hit maps), etc ...

\paragraph{Quality test and report}

Whereas the monitor element provides a summary of a data set, the \textit{quality test} implement the logic of testing an
element or evaluating its quality. These tests are also designed to detect problems as some distribution .......


\begin{itemize}
  \item The plugin system
  \item The event data model abstraction
  \item The event streamer
  \item The monitor element
  \item The quality test + report
  \item Others ?
\end{itemize}

\subsection{The online system}
\label{subsec:online}

\begin{itemize}
  \item The analysis module
  \item The standalone module
  \item The collectors: events and monitor elements
  \item Interface to DAQ systems: run control and event source
  \item Others ?
\end{itemize}

\subsection{The online visualization}
\label{subsec:vis}

\begin{itemize}
  \item The job control Gui
  \item The Qt Gui
  \item Toward a web interface (work in progress)
\end{itemize}

+ screenshots

\section{Detectors using DQM4hep}
\label{sec:detectors}

\begin{itemize}
  \item SDHCAL test-beams
  \item Combined test beam with SiWECal
  \item AHCal test-beams
  \item DREAM test-beams ???
\end{itemize}

\section{Conclusion}
\label{sec:conclusion}

Conclusion \\
+ extensions:

\begin{itemize}
  \item Web interface
  \item Continuous integration
\end{itemize}

\section{Aknowledgment}
\label{sec:aknowledgment}

If DREAM calorimeter, AIDA2020 aknowledgments


% \section{Introduction}
% \label{intro}
% Your text comes here. Separate text sections with
% \section{Section title}
% \label{sec-1}
% For bibliography use \cite{RefJ}
% \subsection{Subsection title}
% \label{sec-2}
% Don't forget to give each section, subsection, subsubsection, and
% paragraph a unique label (see Sect.~\ref{sec-1}).
%
% For one-column wide figures use syntax of figure~\ref{fig-1}
% \begin{figure}[h]
% % Use the relevant command for your figure-insertion program
% % to insert the figure file.
% \centering
% %\includegraphics[width=1cm,clip]{tiger}
% \caption{Please write your figure caption here}
% \label{fig-1}       % Give a unique label
% \end{figure}
%
% For two-column wide figures use syntax of figure~\ref{fig-2}
% \begin{figure*}
% \centering
% % Use the relevant command for your figure-insertion program
% % to insert the figure file. See example above.
% % If not, use
% \vspace*{5cm}       % Give the correct figure height in cm
% \caption{Please write your figure caption here}
% \label{fig-2}       % Give a unique label
% \end{figure*}
%
% For figure with sidecaption legend use syntax of figure
% \begin{figure}
% % Use the relevant command for your figure-insertion program
% % to insert the figure file.
% \centering
% \sidecaption
% %\includegraphics[width=5cm,clip]{tiger}
% \caption{Please write your figure caption here}
% \label{fig-3}       % Give a unique label
% \end{figure}
%
% For tables use syntax in table~\ref{tab-1}.
% \begin{table}
% \centering
% \caption{Please write your table caption here}
% \label{tab-1}       % Give a unique label
% % For LaTeX tables you can use
% \begin{tabular}{lll}
% \hline
% first & second & third  \\\hline
% number & number & number \\
% number & number & number \\\hline
% \end{tabular}
% % Or use
% \vspace*{5cm}  % with the correct table height
% \end{table}
%
% BibTeX or Biber users please use (the style is already called in the class, ensure that the "woc.bst" style is in your local directory)
% \bibliography{name or your bibliography database}
%
% Non-BibTeX users please use
%
\begin{thebibliography}{}
%
% and use \bibitem to create references.
%
\bibitem{RefJ}
% Format for Journal Reference
Journal Author, Journal \textbf{Volume}, page numbers (year)
% Format for books
\bibitem{RefB}
Book Author, \textit{Book title} (Publisher, place, year) page numbers
% etc
\end{thebibliography}

\end{document}

% end of file template.tex

%<div id='footer'><table width='100%'><tr><td class='right'><a href='http://fusioninventory.org/'><span class='copyright'>FusionInventory 9.1+1.0 | copyleft <img src='/glpi/plugins/fusioninventory/pics/copyleft.png'/>  2010-2016 by FusionInventory Team</span></a></td></tr></table></div>
